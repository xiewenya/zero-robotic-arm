# 角度显示改进说明

## 改进内容

修改了角度读取和显示逻辑，使其根据关节的实际角度范围进行智能转换显示。

## 修改前后对比

### 修改前：所有角度统一显示为 0-360° 范围

| 关节 | 角度范围 | 实际编码器读数 | 显示角度（旧） | 问题 |
|------|---------|--------------|--------------|------|
| 关节1 | 0°~360° | 280° | 280° | ✅ 正确 |
| 关节2 | 90°~180° | 100° | 100° | ✅ 正确 |
| 关节3 | -90°~90° | 280° | 280° | ❌ 应该显示 -80° |
| 关节4 | -90°~90° | 270° | 270° | ❌ 应该显示 -90° |
| 关节5 | 0°~90° | 350° | 350° | ❌ 应该显示 -10° 或显示超出范围 |

### 修改后：根据关节角度范围智能转换

| 关节 | 角度范围 | 实际编码器读数 | 显示角度（新） | 说明 |
|------|---------|--------------|--------------|------|
| 关节1 | 0°~360° | 280° | 280° | ✅ 全周旋转，保持原值 |
| 关节2 | 90°~180° | 100° | 100° | ✅ 在范围内，保持原值 |
| 关节3 | -90°~90° | 280° | **-80°** | ✅ 自动转换：280° - 360° = -80° |
| 关节4 | -90°~90° | 270° | **-90°** | ✅ 自动转换：270° - 360° = -90° |
| 关节5 | 0°~90° | 350° | **-10°** 或 保持350° | ⚠️ 如果-10°不在范围内，保持原值 |

## 技术实现

### 修改的函数

**文件：** `2. Software/robot/Core/Src/robot.c`

**函数：** `robot_update_current_angle()`

```c
// 转换为度数
angle = angle * 360 / 65536 / joint->reduction_ratio + g_joints_init[joint_id].current_angle;

// 根据关节角度范围进行转换显示
float normalized_angle = robot_angle_normalize(angle);  // 先规范化到 0-360°
float mapped_angle = 0;
int ret = robot_angle_map(normalized_angle, g_joints_init[joint_id].min_angle, 
                          g_joints_init[joint_id].max_angle, &mapped_angle);

if (ret == 0) {
    joint->current_angle = mapped_angle;  // 使用映射后的角度
} else {
    // 如果映射失败（角度超出范围），使用规范化后的角度（0-360度）
    joint->current_angle = normalized_angle;
}
```

### 转换逻辑

`robot_angle_map()` 函数会尝试将角度映射到 `[min_angle, max_angle]` 范围：

1. **在范围内**：直接使用
2. **小于 min_angle**：尝试 +360° 映射
3. **大于 max_angle**：尝试 -360° 映射
4. **仍超出范围**：返回错误（使用原始规范化值）

## 实际应用示例

### 示例1：关节3（-90°~90°范围）

```bash
# 发送命令
abs_rotate 3 280

# 系统处理：
# 1. 电机旋转到 280°
# 2. 读取角度：280°
# 3. 规范化：280°（在0-360范围内）
# 4. 映射到[-90, 90]：280° - 360° = -80°
# 5. 显示：-80°

# 读取角度
read_angle 3
# 输出：Joint 3: -80.00°  ✓
```

### 示例2：关节1（0°~360°范围）

```bash
# 发送命令
abs_rotate 1 280

# 系统处理：
# 1. 电机旋转到 280°
# 2. 读取角度：280°
# 3. 规范化：280°
# 4. 映射到[0, 360]：280°（无需转换）
# 5. 显示：280°

# 读取角度
read_angle 1
# 输出：Joint 1: 280.00°  ✓
```

## 优势

1. ✅ **直观显示**：角度显示符合关节物理范围定义
2. ✅ **一致性**：读取和设置使用相同的角度表示
3. ✅ **易理解**：对于有负角度范围的关节，显示负值更自然
4. ✅ **减少混淆**：避免"280°"和"-80°"混用的困惑

## 影响的命令

以下命令的角度显示都会受益于此改进：

- `read_angle <joint_id>` - 读取单个关节角度
- `read_all_angles` - 读取所有关节角度
- `read_status <joint_id>` - 显示关节状态（包含当前角度）
- 运动控制日志输出

## 注意事项

1. **编码器原始数据不变**：只是显示方式改变，底层编码器数据仍然准确
2. **兼容性**：所有现有命令仍然正常工作
3. **超出范围处理**：如果角度无法映射到关节范围，会保留0-360°的显示

## 相关修改

- ✅ `rel_rotate` 和 `abs_rotate` 添加了角度范围检查
- ✅ 角度读取根据关节范围智能显示
- ✅ 所有运动控制模式都有完整的角度保护机制

---

**修改日期：** 2025-12-23
**版本：** v1.1

